function sendData(e){null!=peerConnection?(console.log("Sent to opponent: ",e),peerConnection.send(e)):console.log("Can not send json to opponent! connection is null")}function onDataReceived(e){console.log("Received from opponent: ",e);var a=e.gameState;switch(a){case 1:renamePlayButton(stringGameCommencing),insertBallDelayed(!0,countdownDuration),lastBallStartOnLeft=!0;break;case 2:isSlaveReady=!0,isMasterReady&&startGame();break;case 3:isMasterReady=!0,isSlaveReady=!0,lastBallStartOnLeft=leftIsLocalStream,startGame();break;case 4:bumsSound.play();break;case 5:var t=e.scoreLeft,i=e.scoreRight;t>leftPlayerScore&&(leftPlayerScore=t),i>rightPlayerScore&&(rightPlayerScore=i),refreshScores(leftPlayerScore,rightPlayerScore),checkWinnerAndInsertBall();break;default:var o={name:"circle",labels:[labelBall]},n=gWorld.find(o),l=n[0];l.state.pos.x=e.ball.x,l.state.pos.y=e.ball.y,l.state.vel.x=e.ball.vx,l.state.vel.y=e.ball.vy,l.radius=e.ball.radius,l.styles.fillStyle=e.ball.color}}function makeCall(e){var a,t;e?(a=peer.call($("#callto-id").val(),local_video_stream),t=peer.connect($("#callto-id").val(),{label:"data_channel"})):(a=peer.call(callIDParameter,local_video_stream),t=peer.connect(callIDParameter,{label:"data_channel"})),t.on("open",function(){peerConnection=t}),t.on("data",function(e){onDataReceived(e)}),a.on("stream",function(e){assertVideoStreams(!1,e),isCalibrated&&renameButtonToPlayAndEnableIt(stringPlay)})}function assertVideoStreams(e,a){remote_video_stream=a,leftIsLocalStream=e,e?(attachMediaStream($("#left_video").first(),local_video_stream),attachMediaStream($("#right_video").first(),remote_video_stream),$("#right_video").prop("src",URL.createObjectURL(remote_video_stream)),$("#left_video").prop("src",URL.createObjectURL(local_video_stream))):(attachMediaStream($("#left_video").first(),remote_video_stream),attachMediaStream($("#right_video").first(),local_video_stream),$("#right_video").prop("src",URL.createObjectURL(local_video_stream)),$("#left_video").prop("src",URL.createObjectURL(remote_video_stream)))}function launchVideoStream(){getUserMedia({video:!0,audio:!1},videoLaunchSuccess,videoLaunchFailed)}function videoLaunchSuccess(e){var a=document.querySelector("#left_video");attachMediaStream(a,e),local_video_stream=e,$(".animation_container").show(),$("#viewport").show(),$(".debugBlock").show(),$(".waitingCameraStream").hide(),$(".streamStartedBlock").show(),$(".scoreContainer").show(),$(".container").css("margin-top","10px"),adjustCanvasToFitVideoStream(),drawVideoToCanvas(),insertPhysics(),initEvents(),setInterval(refresh,100)}function videoLaunchFailed(){var e="Sorry, but your camera is busy or your browser is not supporting getUserMedia()!";console.log(e),alert(e)}function drawVideoToCanvas(){var e=document.querySelector("#left_video"),a=document.querySelector("#right_video"),t=document.getElementById("left_video_canvas"),i=document.getElementById("right_video_canvas"),o=t.getContext("2d"),n=i.getContext("2d");e.played&&(leftIsLocalStream?(displayLeftVideoDownscaledContext.clearRect(0,0,displayLeftVideoDownscaled.width,displayLeftVideoDownscaled.height),displayLeftVideoDownscaledContext.drawImage(e,0,0,displayLeftVideoDownscaled.width,displayLeftVideoDownscaled.height),video=chooseVideo(e),o.clearRect(0,0,t.width,t.height),o.drawImage(video,0,0,t.width,t.height)):(o.clearRect(0,0,t.width,t.height),o.drawImage(e,0,0,t.width,t.height))),a.played&&(leftIsLocalStream?(n.clearRect(0,0,i.width,i.height),n.drawImage(a,0,0,i.width,i.height)):(displayLeftVideoDownscaledContext.clearRect(0,0,displayLeftVideoDownscaled.width,displayLeftVideoDownscaled.height),displayLeftVideoDownscaledContext.drawImage(a,0,0,displayLeftVideoDownscaled.width,displayLeftVideoDownscaled.height),video=chooseVideo(a),n.clearRect(0,0,i.width,i.height),n.drawImage(video,0,0,i.width,i.height)))}function chooseVideo(e){var a=parseInt($("input[name='imageProccessing']:checked").val()),t=e;switch(a){case 1:t=displaySubtractedBackground;break;case 2:t=displayForegroundthreshold;break;case 3:t=displayMedian;break;case 4:t=displayMedianEdges;break;default:t=e}return t}function adjustCanvasToFitVideoStream(){$(".animation_container").css({left:$("#left_video_canvas").position().left,top:0}),$("#viewport, .animation_container").css({width:2*$(".video").width(),height:$(".video").position().top+$(".video").height()-animationOffset}),left_canvas=document.getElementById("left_video_canvas"),right_canvas=document.getElementById("right_video_canvas"),displayLeftVideoDownscaled=document.getElementById("displayLeftVideoDownscaled"),displaySubtractedBackground=document.getElementById("displaySubtractedBackground"),displayForegroundthreshold=document.getElementById("displayForegroundthreshold"),displayMedian=document.getElementById("displayMedian"),displayMedianEdges=document.getElementById("displayMedianEdges"),displayGradient=document.getElementById("displayGradient"),displayNoBackground=document.getElementById("displayNoBackground"),displayPhoto=document.getElementById("displayNoBackground"),videoWidth=left_canvas.width=right_canvas.width=left_canvas.clientWidth,videoWidthScaled=displayLeftVideoDownscaled.width=displaySubtractedBackground.width=displayForegroundthreshold.width=displayMedian.width=displayMedianEdges.width=displayGradient.width=displayNoBackground.width=displayPhoto.width=displayLeftVideoDownscaled.clientWidth,videoHeight=left_canvas.height=right_canvas.height=left_canvas.clientHeight,displayLeftVideoDownscaled.height=displaySubtractedBackground.height=displayForegroundthreshold.height=displayMedian.height=displayMedianEdges.height=displayGradient.height=displayNoBackground.height=displayPhoto.height=displayLeftVideoDownscaled.clientHeight,videoWidthDivHeight=videoWidth/videoHeight,skip=videoWidthScaled*(medianMaskSize-1)<<2,fastMedianStartingPixel=videoWidthScaled*halfOfTheMaskSize+halfOfTheMaskSize<<2,medianMaskSizeTimesFourTimesWidth=videoWidthScaled*medianMaskSizeTimesFour,scalingFactor=videoWidth/videoWidthScaled,medianMaskSizeTimesScalingFactor=medianMaskSize*scalingFactor,medianMaskSizeDivTwoTimesScalingFactor=medianMaskSizeTimesScalingFactor>>1,videoWidthMinusOne=videoWidth-1,left_canvas_ctx=left_canvas.getContext("2d"),right_canvas_ctx=right_canvas.getContext("2d"),displayLeftVideoDownscaledContext=displayLeftVideoDownscaled.getContext("2d"),displaySubtractedBackgroundContext=displaySubtractedBackground.getContext("2d"),displayForegroundthresholdContext=displayForegroundthreshold.getContext("2d"),displayMedianContext=displayMedian.getContext("2d"),displayMedianEdgesContext=displayMedianEdges.getContext("2d"),displayGradientContext=displayGradient.getContext("2d"),displayNoBackgroundContext=displayNoBackground.getContext("2d"),displayPhotoContext=displayPhoto.getContext("2d")}function sendBallToAnotherScreen(e){ballRadius=e.radius;var a={ball:{x:e.state.pos.x,y:e.state.pos.y,vx:e.state.vel.x,vy:e.state.vel.y,radius:ballRadius,mass:e.mass,color:e.styles.fillStyle}};sendData(a)}function insertPhysics(){var e=2*$(".stream").width(),a=$(".stream").height()-25,t=videoHeight-ballRadius,i=t-10,o=videoWidth>>1;videoWidthDivTwo=videoWidth>>1,Physics(function(t){var n=Physics.renderer("canvas",{el:"viewport",meta:!0,width:e,height:a});t.add(n);var l=Physics.body("rectangle",{labels:[labelNet],x:videoWidth,y:o,width:10,height:o,cof:.8,restitution:.8,treatment:"static",styles:{fillStyle:"#83F52C",strokeStyle:"rgba(0, 0, 0, 1.0)",lineWidth:3}});t.add(l),t.render(),Physics.util.ticker.on(function(e){t.step(e)}),Physics.util.ticker.start(),t.on("step",function(){t.render()});var d=Physics.aabb($("#viewport").position().left,-600,$("#viewport").width(),$("#viewport").height());t.add([Physics.behavior("constant-acceleration",{acc:{x:0,y:4e-4}}),Physics.behavior("edge-collision-detection",{restitution:1,cof:.99,aabb:d}),Physics.behavior("body-impulse-response"),Physics.behavior("body-collision-detection"),Physics.behavior("sweep-prune")]);var r=Physics.query({$or:[{bodyA:{labels:labelHuman},bodyB:{labels:labelBall}},{bodyB:{labels:labelHuman},bodyA:{labels:labelBall}}]});t.on("collisions:detected",function(e){var a={name:"circle",labels:[labelBall]},t=gWorld.find(a),o=t[0];if(o.state.pos.y>=i)o.state.pos.x<left_canvas.width?leftIsLocalStream&&(refreshScores(leftPlayerScore,++rightPlayerScore),notifyOponentScoreValues(leftPlayerScore,rightPlayerScore),checkWinnerAndInsertBall()):leftIsLocalStream||(refreshScores(++leftPlayerScore,rightPlayerScore),notifyOponentScoreValues(leftPlayerScore,rightPlayerScore),checkWinnerAndInsertBall());else{notifyBumsSound(),bumsSound.play();var n=Physics.util.find(e.collisions,r);if(n){var l;l=leftIsLocalStream?o.state.vel.x+.2:o.state.vel.x-.2;var d=o.state.vel.y-.2,s=calculateSpeed(l,d);if(s>maxSpeedAllowed){var c=maxSpeedAllowed/s;l*=c,d*=c}o.state.vel.set(l,d)}leftIsLocalStream?o.state.pos.x<=left_canvas.width&&sendBallToAnotherScreen(o):o.state.pos.x>left_canvas.width&&sendBallToAnotherScreen(o)}}),gWorld=t})}function initEvents(){callIDParameter&&makeCall(!1),$("#calibrate").on("click",function(){return calibrate(displayLeftVideoDownscaled,displayPhoto),!1}),$(".make-call").on("click",function(){return makeCall(!0),!1}),$("#play").on("click",function(){return disablePlayButton(),$("#play").text()==stringRestart?leftIsLocalStream?startGame():(lastBallStartOnLeft=leftIsLocalStream,notifyMasterRestartRequested()):leftIsLocalStream?isSlaveReady?startGame():(isMasterReady=!0,renamePlayButton(stringWaitingForOtherPlayer)):(renamePlayButton(stringWaitingForOtherPlayer),notifyMasterIAmReady()),!1})}function calibrate(e,a){var t=e.getContext("2d"),i=a.getContext("2d");if(subtractionPhoto=t.getImageData(0,0,e.width,e.height),i.putImageData(subtractionPhoto,0,0),isCalibrated=!0,"undefined"!=typeof remote_video_stream){var o=stringPlay;$("#play").text()==stringRestart&&(o=stringRestart),enablePlayButton(),renamePlayButton(o)}else renamePlayButton("no oponent")}function refresh(){var e,a,t,i,o,n;if(drawVideoToCanvas(),"undefined"!=typeof subtractionPhoto&&(e=displayLeftVideoDownscaledContext.getImageData(0,0,displayLeftVideoDownscaled.width,displayLeftVideoDownscaled.height),"undefined"!=typeof subtractionPhoto)){a=subtract(e,subtractionPhoto),t=displayMedianContext.getImageData(0,0,displayMedian.width,displayMedian.height),i=displayMedianEdgesContext.createImageData(displayMedianEdges.width,displayMedianEdges.height),displaySubtractedBackgroundContext.putImageData(a,0,0),o=thresholdImage(a,thresholdValue),n=fastMedianFilter(e,t,i,medianMaskSize),t=n[0],i=n[1],displayMedianContext.putImageData(t,0,0),displayMedianEdgesContext.putImageData(i,0,0),displayForegroundthresholdContext.putImageData(o,0,0);var l=Array.prototype.push,d=humanCoordinates.length,r=0;leftIsLocalStream||(r=left_canvas.width);for(var s,c,h,u,y,f,g=0;d>g;g++)s=humanCoordinates[g],c=s>>2,h=c*scalingFactor,u=videoWidthMinusOne-c%videoWidthScaled*scalingFactor,y=Math.floor(h/videoWidthScaled)+animationOffset,g<gHumanSquares.length?(f=gHumanSquares[g],f.state.pos.x=u+r,f.state.pos.y=y,f.hidden=!1):(f=Physics.body("circle",{labels:[labelHuman],radius:medianMaskSizeDivTwoTimesScalingFactor,treatment:"static",x:u+r,y:y,cof:.8,restitution:1,styles:{fillStyle:"rgba(181, 137, 0, 0.4)"}}),gWorld.add(f),l.apply(gHumanSquares,[f]));var m=gHumanSquares.length;if(m>d)for(var g=d;m>g;g++)f=gHumanSquares[g],f.state.pos.x=0,f.state.pos.y=0,f.hidden=!0}}function subtract(e,a){for(var t=e.data,i=a.data,o=t.length/4,n=0;o>n;n++)for(var l=0;3>l;l++)t[4*n+l]<i[4*n+l]?t[4*n+l]=i[4*n+l]-t[4*n+l]:t[4*n+l]-=i[4*n+l];return e}function fastMedianFilter(e,a,t,i){humanCoordinates=[];for(var o,n,l,d,r,s,c,h,u,y,f,g,m=[],p=a.data.length,v=p-1,S=(Array.prototype.push,fastMedianStartingPixel),b=p;b>S;S+=medianMaskSizeTimesFour){o=S,n=S>>2,l=0,d=a.width,r=[];for(var w=0;i>w;w++){s=(w-halfOfTheMaskSize)*d;for(var x=0;i>x;x++)c=o+(s+x-halfOfTheMaskSize<<2),(0>c||c>v)&&(c=o),h=e.data[c],r.push(c),h&&l++}if(m.push(r),u=r.length,l>halfOfTheMaskSquare)for(var B=0;u>B;B++)y=r[B],a.data[y]=a.data[y+1]=a.data[y+2]=255,a.data[y+3]=255;else for(var B=0;u>B;B++)y=r[B],a.data[y]=a.data[y+1]=a.data[y+2]=0,a.data[y+3]=255;d=a.width,f=n%d,g=(n+i)%d,f>=g&&(S+=skip)}for(var P,M,k,_,I,C,L,D,$,T=[],W=m.length,S=0;W>S;S++)if(P=m[S],M=P[halfOfTheMaskSquare],k=a.data[M],0!=k){_=!1;for(var R=-1;2>R&&!_;R+=2){I=M+R*medianMaskSizeTimesFourTimesWidth;for(var w=-1;2>w;w+=2)if(C=I+w*medianMaskSizeTimesFour,!(0>C||C>v)&&k!=a.data[C]){humanCoordinates.push(M),T.push(P),_=!0;break}}}if(0!=t){L=T.length;for(var S=0;L>S;S++){D=T[S],anEdgeBlockLength=D.length;for(var R=0;anEdgeBlockLength>R;R++)$=D[R],t.data[$]=t.data[$+1]=t.data[$+2]=0,t.data[$+3]=255}}return[a,t]}function thresholdImage(e,a){for(var t,i,o,n=e.data,l=n.length,d=0;l>d;d+=4)t=d,i=t+1,o=i+1,n[t]=n[i]=n[o]=n[t]<a&&n[i]<a&&n[o]<a?0:255;return e}function calculateGrayValue(e,a,t){return Math.round(.299*e+.587*a+.114*t)}function refreshScores(e,a){$("#leftPlyerSpan").text(e),$("#rightPlayerSpan").text(a)}function enablePlayButton(){$("#play").prop("disabled",!1)}function disablePlayButton(){$("#play").prop("disabled",!0)}function renamePlayButton(e){$("#play").text(e)}function insertBall(e){pfiffSound.play();var a;a=e?videoWidthDivTwo:videoWidth+videoWidthDivTwo;var t=0,i=0,o=0,n="#ff0000",l={name:"circle",labels:[labelBall]},d=gWorld.find(l),r=d[0],s=d.length>0;if(s)r.state.pos.x=a,r.state.pos.y=t,r.state.vel.x=i,r.state.vel.y=o;else{var c=Physics.body("circle",{labels:[labelBall],x:a,y:t,vx:i,vy:o,cof:.8,restitution:1,radius:ballRadius,treatment:"dynamic",styles:{fillStyle:n,angleIndicator:"#751b4b"}});c.view=new Image,c.view.src="img/volleyball_scaled.png",gWorld.add(c)}}function insertBallDelayed(e,a){"undefined"!=countdownTimerID&&clearInterval(countdownTimerID);var t=$("#countdown");t.text(a--),countdownTimerID=setInterval(function(){switch(a){case 0:t.text("GO!"),a--;break;case-1:clearInterval(countdownTimerID),t.text(""),insertBall(e);break;default:t.text(a--)}},1e3),isSlaveReady=!1,isMasterReady=!1,refreshScores(leftPlayerScore=0,rightPlayerScore=0),renamePlayButton(stringRestart),enablePlayButton()}function removeBallFromField(){var e={name:"circle",labels:[labelBall]},a=gWorld.find(e);a.length>0&&gWorld.remove(a[0])}function notifyOtherPlayerBallInField(){var e={gameState:1};sendData(e)}function notifyMasterIAmReady(){var e={gameState:2};sendData(e)}function notifyMasterRestartRequested(){var e={gameState:3};sendData(e)}function notifyBumsSound(){var e={gameState:4};sendData(e)}function notifyOponentScoreValues(e,a){var t={gameState:5,scoreLeft:e,scoreRight:a};sendData(t)}function startGame(){lastBallStartOnLeft=leftIsLocalStream,notifyOtherPlayerBallInField(),insertBallDelayed(lastBallStartOnLeft,countdownDuration),renamePlayButton(stringRestart)}function renameButtonToPlayAndEnableIt(e){renamePlayButton(e),enablePlayButton()}function calculateSpeed(e,a){return Math.sqrt(e*e+a*a)}function checkWinnerAndInsertBall(){var e=document.getElementById("countdown");leftPlayerScore>=maxScore?(removeBallFromField(),leftIsLocalStream?(e.innerHTML="YOU WON!",ovationSound.play()):(e.innerHTML="YOU LOST!",booSound.play())):rightPlayerScore>=maxScore?(removeBallFromField(),leftIsLocalStream?(e.innerHTML="YOU LOST!",booSound.play()):(e.innerHTML="YOU WON!",ovationSound.play())):insertBall(lastBallStartOnLeft=!lastBallStartOnLeft)}function getUrlParams(){for(var e,a=[],t=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),i=0;i<t.length;i++)e=t[i].split("="),a.push(e[0]),a[e[0]]=e[1];return a}var local_video_stream,remote_video_stream,peerConnection,leftIsLocalStream=!0,callIDParameter="",bumsSound=new Audio("sounds/bums.wav"),pfiffSound=new Audio("sounds/pfiff.wav"),ovationSound=new Audio("sounds/ovation.wav"),booSound=new Audio("sounds/boo.wav"),leftPlayerScore=0,rightPlayerScore=0,isCalibrated=!1,lastBallStartOnLeft=leftIsLocalStream,countdownTimerID,countdownDuration=5,isSlaveReady=!1,isMasterReady=!1,maxScore=5,stringWaitingForOtherPlayer="Waiting for other player",stringGameCommencing="Commencing...",stringPlay="PLAY!",stringRestart="Restart",gWorld=null,labelBall="labelBall",labelNet="labelNet",labelHuman="labelHuman",ballRadius=20,maxSpeedAllowed=.5,maxSpeedSoFar=0,animationOffset=40,humanCoordinates=[],gHumanSquares=[],gHuman,left_canvas,right_canvas,displayLeftVideoDownscaled,displaySubtractedBackground,displayForegroundthreshold,displayMedian,displayMedianEdges,displayGradient,displayNoBackground,displayPhoto,left_canvas_ctx,right_canvas_ctx,displayLeftVideoDownscaledContext,displaySubtractedBackgroundContext,displayForegroundthresholdContext,displayMedianContext,displayMedianEdgesContext,displayGradientContext,displayNoBackgroundContext,displayPhotoContext,videoWidthScaled,videoWidth,videoHeight,videoWidthDivHeight,videoWidthDivTwo,videoWidthMinusOne,scalingFactor,medianMaskSizeTimesScalingFactor,medianMaskSizeDivTwoTimesScalingFactor,peer=new Peer({key:"27ayhd78o9u23xr",debug:3,config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}});peer.on("open",function(){$("#my-id").val(document.URL+"?call="+peer.id)}),peer.on("call",function(e){e.answer(local_video_stream),e.on("stream",function(e){assertVideoStreams(!0,e)}),isCalibrated&&renameButtonToPlayAndEnableIt(stringPlay)}),peer.on("connection",function(e){peerConnection=e,"data_channel"==peerConnection.label&&peerConnection.on("data",function(e){onDataReceived(e)})}),$(document).ready(function(){var e=getUrlParams().call;"undefined"!=e&&e&&(callIDParameter=e),$("#my-id").on("click",function(){return $(this).select(),!1}),thresholdValue=parseInt($("#thresholdSlider").val()),$("#thresholdSlider").on("input",function(){$("#thresholdInput").text($(this).val()),thresholdValue=parseInt($(this).val())}),$("#debugCheckbox").bootstrapSwitch(),$("#debugCheckbox").on("switchChange.bootstrapSwitch",function(){return $("#debugCheckbox").bootstrapSwitch("state")?$(".visibleOnDebug").show():$(".visibleOnDebug").hide(),!1}),launchVideoStream()});var medianMaskSize=5,thresholdValue=10,halfOfTheMaskSize=Math.floor(medianMaskSize>>1),halfOfTheMaskSquare=Math.floor(medianMaskSize*medianMaskSize>>1),medianMaskSizeTimesFour=medianMaskSize<<2,skip,fastMedianStartingPixel,medianMaskSizeTimesFourTimesWidth,subtractionPhoto;